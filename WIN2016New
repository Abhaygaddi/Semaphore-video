---
- name: Install Windows patch from Samba share without copying
  hosts: WIN2016
  gather_facts: no
  vars:
    samba_share_path: "\\\\192.168.29.78\\winpatches"
    patch_filename: "KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"

  tasks:

    - name: Map network share using Samba credentials
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} {{ samba_password }} /user:{{ samba_user }}
      register: map_result
      changed_when: "'The command completed successfully.' in map_result.stdout"
      failed_when: "'error' in map_result.stderr.lower()"

    - name: Run Windows Update patch directly from network share
      ansible.windows.win_command: >
        cmd.exe /c wusa {{ samba_share_path }}\\{{ patch_filename }} /quiet /norestart
      register: patch_result
      failed_when: patch_result.rc != 0

    - name: Wait for patch installation to settle
      ansible.builtin.pause:
        seconds: 20

    - name: Unmap network share
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} /delete
      register: unmap_result
      changed_when: "'successfully' in unmap_result.stdout.lower()"
      failed_when: false  # suppress error if already unmapped

    - name: Print installation result
      debug:
        var: patch_result.stdout_lines
