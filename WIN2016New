---
- name: Install Windows updates from SMB share using local credentials
  hosts: windows
  gather_facts: no
  vars:
    share_path: '\\192.168.29.78\winpatches'
    drive_letter: 'Z'
    local_user: 'smbuser'
    local_pass: '0pT1mus9r1me#'
    updates:
      - KB5058921.msu
      - KB5055521.msu

  tasks:

    - name: Install updates from SMB share
      win_shell: |
        $username = "{{ local_user }}"
        $password = "{{ local_pass }}"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

        New-PSDrive -Name {{ drive_letter }} -PSProvider FileSystem -Root "{{ share_path }}" -Credential $credential | Out-Null

        foreach ($patch in {{ updates | to_json | from_json }}) {
          Start-Process -FilePath "wusa.exe" -ArgumentList "{{ drive_letter }}:\\$patch /quiet /norestart" -Wait
        }

        Remove-PSDrive -Name {{ drive_letter }}
      register: result
      failed_when: result.rc != 0
      changed_when: true
