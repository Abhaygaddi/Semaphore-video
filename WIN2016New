---
- name: Install Patch KB5058921 on Windows Server
  hosts: WIN2016
  tasks:
    - name: Map Samba share with domain credentials
      ansible.windows.win_command:
        cmd: "net use Z: \\\\192.168.29.78\\winpatches /user:smbuser \"0pT1mus9r1me#\""
      ignore_errors: yes

    - name: Verify that the network drive is mapped
      ansible.windows.win_command:
        cmd: "dir Z:"
      register: result
      failed_when: result.rc != 0

    - name: Install the patch
      ansible.windows.win_command:
        cmd: "wusa.exe \"Z:\\KB5058921.msu\" /quiet /norestart"
      register: patch_install
      failed_when: patch_install.rc != 0

    - name: Reboot the server if needed after patch installation
      ansible.windows.win_reboot:
        reboot_timeout: 600
        test_command: "echo 'Reboot check'"
      when: patch_install.rc == 0

    - name: Remove the mapped network drive
      ansible.windows.win_command:
        cmd: "net use Z: /delete"
      ignore_errors: yes

    - name: Verify that the network drive has been removed
      ansible.windows.win_command:
        cmd: "net use Z:"
      register: result
      failed_when: result.rc == 0
