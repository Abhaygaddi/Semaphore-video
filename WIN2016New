---
- name: Install Windows patch from network share without copying or mapping
  hosts: windows
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches"
    patch_file: "KB5058921.msu"
    smb_user: "testdc\\ansible"
    smb_password: "0pT1mus9r1me#"

  tasks:
    - name: Install patch using UNC path with credentials
      ansible.windows.win_shell: |
        $user = "{{ smb_user }}"
        $pass = "{{ smb_password }}"
        $securePass = ConvertTo-SecureString $pass -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential($user, $securePass)
        $net = New-Object -ComObject WScript.Network
        $net.MapNetworkDrive("Z:", "{{ patch_share }}", $false, $user, $pass)
        Start-Process -FilePath "wusa.exe" -ArgumentList "Z:\{{ patch_file }} /quiet /norestart" -Wait
        $net.RemoveNetworkDrive("Z:")
      register: patch_result
      failed_when: patch_result.rc != 0
