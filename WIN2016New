---
- name: Install Windows patches from Linux SMB share and log result
  hosts: windows
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches"
    patches:
      - KB5055521.msu
      - KB5058921.msu
    log_path: "C:\\Temp\\patch_log.txt"

  tasks:

    - name: Ensure C:\Temp directory exists
      win_file:
        path: "C:\\Temp"
        state: directory

    - name: Set timestamp
      win_shell: powershell -Command "Get-Date -Format 'yyyy-MM-dd HH:mm:ss'"
      register: timestamp

    - name: Install patches and log results
      block:
        - name: Install patch {{ item }}
          win_command: >
            wusa.exe "{{ patch_share }}\\{{ item }}" /quiet /norestart
          register: patch_result
          ignore_errors: yes

        - name: Log patch result with timestamp and error message
          win_lineinfile:
            path: "{{ log_path }}"
            line: "{{ timestamp.stdout }} : {{ item }} : {{ (patch_result.rc == 0) | ternary('SUCCESS', 'FAILED') }}{{ (patch_result.rc != 0) | ternary(' - ' ~ patch_result.stderr | default(''), '') }}"
            create: yes
      loop: "{{ patches }}"
