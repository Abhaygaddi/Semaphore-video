---
- name: Install Windows patches from Linux SMB share and log result
  hosts: windows
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches"
    patches:
      - KB5055521
      - KB5058921
    log_path: "C:\\Temp\\patch_log.txt"

  tasks:

    - name: Ensure C:\Temp directory exists
      win_file:
        path: "C:\\Temp"
        state: directory

    - name: Install patches and verify with Get-HotFix
      win_shell: |
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $kb = "{{ item }}"
        $patchPath = "{{ patch_share }}\\$kb.msu"

        try {
          Start-Process -FilePath "wusa.exe" -ArgumentList "`"$patchPath`" /quiet /norestart" -Wait -ErrorAction Stop
          Start-Sleep -Seconds 20
          $installed = Get-HotFix -Id $kb -ErrorAction SilentlyContinue
          if ($installed) {
            Add-Content -Path "{{ log_path }}" -Value "$timestamp : $kb : SUCCESS"
          } else {
            Add-Content -Path "{{ log_path }}" -Value "$timestamp : $kb : INSTALL ATTEMPTED BUT NOT FOUND IN SYSTEM"
          }
        } catch {
          Add-Content -Path "{{ log_path }}" -Value "$timestamp : $kb : FAILED - $($_.Exception.Message)"
        }
      loop: "{{ patches }}"

    - name: Reboot the server after patching
      win_reboot:
        reboot_timeout: 600
        msg: "Rebooting after patch installation"
        pre_reboot_delay: 10
        post_reboot_delay: 30
