- name: Install patch from network share via scheduled task as domain user
  hosts: WIN2016
  gather_facts: no
  vars:
    samba_share_path: "\\\\192.168.29.78\\winpatches"
    patch_filename: "KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"
    domain_user: "testdc\\ansible"
    domain_password: "0pT1mus9r1me#"
    task_name: "RunPatchAsDomainUser"
    task_time: "23:59"  # change to a minute or two ahead of current time

  tasks:
    - name: Map network share using Samba credentials
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} {{ samba_password }} /user:{{ samba_user }}
      register: map_result
      failed_when: map_result.rc != 0 and "'The command completed successfully.'" not in map_result.stdout

    - name: Create scheduled task to install the patch using domain account
      ansible.windows.win_command: >
        schtasks /Create /TN {{ task_name }} /TR "wusa {{ samba_share_path }}\\{{ patch_filename }} /quiet /norestart" /SC ONCE /ST {{ task_time }} /RL HIGHEST /RU "{{ domain_user }}" /RP "{{ domain_password }}" /F

    - name: Run the scheduled task
      ansible.windows.win_command: >
        schtasks /Run /TN {{ task_name }}

    - name: Wait for patch installation to complete
      pause:
        seconds: 90
