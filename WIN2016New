---
- name: Install patch from network share as SYSTEM via Scheduled Task
  hosts: WIN2016
  gather_facts: no
  vars:
    samba_share_path: "\\\\192.168.29.78\\winpatches"
    patch_filename: "KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"
    task_name: "RunPatchTask"

  tasks:

    - name: Map network share using Samba credentials
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} {{ samba_password }} /user:{{ samba_user }}
      register: map_result
      changed_when: "'The command completed successfully.' in map_result.stdout"
      failed_when: "'error' in map_result.stderr.lower()"

    - name: Create scheduled task to install the patch as SYSTEM
      ansible.windows.win_command: >
        schtasks /Create /TN {{ task_name }} /TR "wusa {{ samba_share_path }}\\{{ patch_filename }} /quiet /norestart" /SC ONCE /ST 00:00 /RL HIGHEST /RU SYSTEM
      register: create_task
      failed_when: "'ERROR' in create_task.stdout"

    - name: Run the scheduled task
      ansible.windows.win_command: >
        schtasks /Run /TN {{ task_name }}
      register: run_task

    - name: Wait for the task to finish (approx 60 sec)
      ansible.builtin.pause:
        seconds: 60

    - name: Delete scheduled task after completion
      ansible.windows.win_command: >
        schtasks /Delete /TN {{ task_name }} /F
      register: delete_task

    - name: Unmap network share
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} /delete
      register: unmap_result
      failed_when: false
