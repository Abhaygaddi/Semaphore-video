---
- name: Patch Windows
  hosts: windows  # Use the 'windows' group from your inventory
  gather_facts: true
  vars:
    var_category: "SecurityUpdates"  # Default value
    var_state: "installed"  # Default value

  tasks:
    - name: Check var_category variable
      ansible.builtin.assert:
        that:
          - var_category in ["SecurityUpdates", "CriticalUpdates", "UpdateRollups", "*"]
        fail_msg: >-
          var_category must be one of 'SecurityUpdates', 'CriticalUpdates', 'UpdateRollups' or '*.'
          It is set to {{ var_category }}.
        success_msg: "patch category is set to {{ var_category }}."

    - name: Check var_state variable
      ansible.builtin.assert:
        that:
          - var_state in ["installed", "searched", "downloaded"]
        fail_msg: >-
          var_state must be one of 'installed', 'searched', or 'downloaded.'
          It is set to {{ var_state }}.
        success_msg: "patch state is set to {{ var_state }}."

    - name: Patch Windows hosts
      ansible.windows.win_updates:
        category_names: "{{ var_category }}"
        log_path: "{{ log_dir }}"
        skip_optional: true
        state: "{{ var_state }}"
        reboot: true
      with_items: "{{ windows_servers }}"
      loop_control:
        loop_var: windows_server
      when: windows_server.hostname is defined
      vars:
        ansible_host: "{{ windows_server.ip }}"
        ansible_user: "testdc\\ansible"
        ansible_password: "0pT1mus9r1me#"
        ansible_connection: winrm
        ansible_winrm_transport: ntlm
        ansible_port: 5985
        ansible_winrm_server_cert_validation: ignore
