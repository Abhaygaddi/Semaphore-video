- name: Install Windows patch directly from SMB share
  hosts: WIN2016
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches\\KB5058921.msu"
    smb_user: "smbuser"
    smb_password: "0pT1mus9r1me#"

  tasks:

    - name: Map network drive with Samba credentials
      ansible.windows.win_command: >
        cmd.exe /c net use {{ patch_share | regex_replace('\\\\[^\\]+\\[^\\]+\\.*$', '') }}
        {{ smb_password }} /user:{{ smb_user }}
      register: map_result
      failed_when: "'Access is denied' in map_result.stdout"
      changed_when: "'The command completed successfully' in map_result.stdout"

    - name: Install patch from network share
      ansible.windows.win_command: >
        cmd.exe /c wusa.exe {{ patch_share }} /quiet /norestart
      register: install_result
      failed_when: install_result.rc != 0
      changed_when: install_result.rc == 0

    - name: Unmap network drive after installation
      ansible.windows.win_command: >
        cmd.exe /c net use {{ patch_share | regex_replace('\\\\[^\\]+\\[^\\]+\\.*$', '') }} /delete /yes
      ignore_errors: true
