---
- name: Install Windows Patch from Mapped Drive
  hosts: all
  gather_facts: no

  vars:
    patch_kb: KB5058921
    patch_file: KB5058921.msu
    mapped_drive: Z:
    patch_path: "{{ mapped_drive }}\\{{ patch_file }}"
    task_name: Install_{{ patch_kb }}

  tasks:
    - name: Ensure WinRM is running
      win_service:
        name: WinRM
        state: started
        start_mode: auto

    - name: Create log directory
      win_file:
        path: C:\temp
        state: directory

    - name: Clear previous scheduled task if exists
      win_scheduled_task:
        name: "{{ task_name }}"
        state: absent
      ignore_errors: yes

    - name: Install patch directly from mapped drive
      win_command: >
        wusa.exe "{{ patch_path }}" /quiet /norestart
      register: patch_result
      ignore_errors: yes

    - name: Log patch install result
      debug:
        msg: "Patch installation result: {{ patch_result }}"

    - name: Reboot the server if required
      win_reboot:
        reboot_timeout: 600
      when: patch_result.rc == 3010

    - name: Remove the mapped network drive
      win_command: net use Z: /delete
      ignore_errors: yes
