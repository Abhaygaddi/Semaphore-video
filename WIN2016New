- name: Ensure patch folder exists
  ansible.windows.win_file:
    path: C:\Temp\patches
    state: directory

- name: Map share and copy patch locally
  ansible.windows.win_command: >
    cmd.exe /c net use {{ samba_share_path }} {{ samba_password }} /user:{{ samba_user }} &&
    copy {{ samba_share_path }}\\{{ patch_filename }} C:\\Temp\\patches\\ /Y
  register: copy_patch
  changed_when: "'1 file(s) copied' in copy_patch.stdout"

- name: Create task to install patch locally as SYSTEM
  ansible.windows.win_command: >
    schtasks /Create /TN {{ task_name }} /TR "wusa C:\\Temp\\patches\\{{ patch_filename }} /quiet /norestart" /SC ONCE /ST {{ task_time }} /RL HIGHEST /RU SYSTEM

- name: Run the task
  ansible.windows.win_command: >
    schtasks /Run /TN {{ task_name }}

- name: Wait and check if patch installed
  pause:
    seconds: 90
