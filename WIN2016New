- name: Install Windows patch from network share without copying or mapping
  hosts: WIN2016
  tasks:
    - name: Ensure no Z drive exists
      win_shell: |
        if (Test-Path -Path "Z:\\") {
          net use Z: /delete
        }
      register: drive_status
      ignore_errors: yes  # This will prevent the task from failing if Z: doesn't exist

    - name: Map network drive with credentials
      win_shell: |
        net use Z: "\\\\192.168.29.78\\winpatches" /user:testdc\\ansible "0pT1mus9r1me#"
        Start-Process -FilePath "wusa.exe" -ArgumentList "Z:\\KB5058921.msu /quiet /norestart" -Wait
        net use Z: /delete
