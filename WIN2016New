- name: Install Windows updates from SMB
  hosts: windows
  gather_facts: false
  vars:
    local_user: smbuser
    local_pass: "0pT1mus9r1me#"
    share_path: "\\\\192.168.29.78\\winpatches"
    drive_letter: Z
  tasks:
    - name: Install updates from SMB share
      win_shell: |
        $username = "{{ local_user }}"
        $password = "{{ local_pass }}"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

        New-PSDrive -Name {{ drive_letter }} -PSProvider FileSystem -Root "{{ share_path }}" -Credential $credential | Out-Null

        $patches = @('KB5058921.msu', 'KB5055521.msu')
        foreach ($patch in $patches) {
          Start-Process -FilePath "wusa.exe" -ArgumentList "{{ drive_letter }}:\\$patch /quiet /norestart" -Wait
        }

        Remove-PSDrive -Name {{ drive_letter }}
      register: result
      failed_when: result.rc != 0
      changed_when: true
