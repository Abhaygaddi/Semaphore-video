---
- name: Install Windows patches from network share
  hosts: windows
  gather_facts: false

  vars:
    share_path: "\\\\192.168.29.78\\winpatches"
    drive_letter: "Z:"
    share_user: "testdc\\ansible"
    share_pass: "0pT1mus9r1me#"

  tasks:

    - name: Ensure Z: drive is not already mapped
      win_shell: >
        if (Test-Path "{{ drive_letter }}\\") {
            net use {{ drive_letter }} /delete /y
        }

    - name: Map network drive Z: to patch share
      win_shell: >
        net use {{ drive_letter }} "{{ share_path }}" /user:{{ share_user }} {{ share_pass }}
      register: net_use_result
      failed_when: "'Access is denied.' in net_use_result.stderr"

    - name: Install all MSU patches from share
      win_shell: >
        Get-ChildItem -Path {{ drive_letter }}\ -Filter *.msu |
        ForEach-Object { wusa.exe "$($_.FullName)" /quiet /norestart }

    - name: Unmap Z: drive
      win_shell: net use {{ drive_letter }} /delete /y
