---
- name: Install Specific Patch from Linux Samba Share on Windows Server 2016
  hosts: all
  gather_facts: no

  vars:
    patch_kb: KB5058921
    patch_file: KB5058921.msu
    patch_share_path: "\\\\<192.168.29.78>\\winpatches\\KB5058921.msu"
    local_patch_path: "C:\\Temp\\KB5058921.msu"

  tasks:
    - name: Ensure WinRM service is running
      win_service:
        name: WinRM
        state: started
        start_mode: auto

    - name: Start Windows Update service
      win_service:
        name: wuauserv
        state: started
        start_mode: auto

    - name: Create Log Directory
      win_file:
        path: C:\temp
        state: directory

    - name: Copy patch from Samba share to local disk
      win_command: >
        cmd.exe /c copy {{ patch_share_path }} {{ local_patch_path }}
      args:
        creates: "{{ local_patch_path }}"

    - name: Install specific patch
      win_command: >
        wusa.exe {{ local_patch_path }} /quiet /norestart
      register: patch_install
      ignore_errors: yes

    - name: Log patch install result
      win_shell: |
        "$((Get-Date).ToString()) - Patch {{ patch_kb }} Install Status: {{ 'Success' if patch_install.rc == 0 else 'FAILED' }}" |
        Out-File -FilePath C:\temp\{{ patch_kb }}_install.log -Append

    - name: Reboot if Required
      win_reboot:
        reboot_timeout: 3600
      when: patch_install.rc == 3010  # 3010 = success + reboot required
