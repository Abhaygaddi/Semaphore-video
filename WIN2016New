---
- name: Install Windows patch from network share using temporary mapped drive
  hosts: windows
  gather_facts: no
  vars:
    patch_filename: KB5058921.msu
    patch_share: "\\\\192.168.29.78\\winpatches"
    patch_drive: "Z:"
    smb_user: "testdc\\ansible"
    smb_password: "0pT1mus9r1me#"

  tasks:

    - name: Map network drive Z:
      ansible.windows.win_command: >
        cmd.exe /c net use {{ patch_drive }} {{ patch_share }} /user:{{ smb_user }} "{{ smb_password }}"
      register: map_result
      failed_when: "'The command completed successfully' not in map_result.stdout"

    - name: Install patch from mapped drive
      ansible.windows.win_command: >
        cmd.exe /c wusa.exe {{ patch_drive }}\\{{ patch_filename }} /quiet /norestart
      register: patch_result
      failed_when: patch_result.rc != 0

    - name: Unmap network drive Z:
      ansible.windows.win_command: >
        cmd.exe /c net use {{ patch_drive }} /delete /yes
      ignore_errors: true
