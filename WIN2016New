---
- name: Install Windows Patch from UNC Path using Scheduled Task
  hosts: all
  gather_facts: no

  vars:
    patch_kb: KB5058921
    patch_file: KB5058921.msu
    samba_server: 192.168.29.78
    samba_share: winpatches
    unc_patch_path: "\\\\{{ samba_server }}\\{{ samba_share }}\\{{ patch_file }}"
    task_name: Install_{{ patch_kb }}

  tasks:
    - name: Ensure WinRM is running
      win_service:
        name: WinRM
        state: started
        start_mode: auto

    - name: Create log directory
      win_file:
        path: C:\temp
        state: directory

    - name: Clear previous scheduled task if exists
      win_scheduled_task:
        name: "{{ task_name }}"
        state: absent
      ignore_errors: yes

    - name: Create scheduled task to install patch from UNC path
      win_scheduled_task:
        name: "{{ task_name }}"
        description: "Install patch {{ patch_kb }} from network share"
        actions:
          - path: wusa.exe
            arguments: "{{ unc_patch_path }} /quiet /norestart"
        username: SYSTEM
        run_level: highest
        state: present
        enabled: yes

    - name: Run the scheduled task
      win_scheduled_task:
        name: "{{ task_name }}"
        state: started

    - name: Wait for scheduled task to complete (optional)
      win_shell: |
        do {
          Start-Sleep -Seconds 10
          $status = (Get-ScheduledTask -TaskName "{{ task_name }}").State
        } while ($status -ne 'Ready' -and $status -ne 'Disabled')
      async: 180
      poll: 0

    - name: Remove scheduled task after execution
      win_scheduled_task:
        name: "{{ task_name }}"
        state: absent
        ignore_errors: yes

    - name: Log patch install event
      win_shell: |
        "$((Get-Date).ToString()) - Patch {{ patch_kb }} install task triggered from UNC path." |
        Out-File -FilePath C:\temp\{{ patch_kb }}_install.log -Append
