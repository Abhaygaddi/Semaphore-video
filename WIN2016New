---
- name: Install Windows patches from SMB share with credentials
  hosts: WIN2016
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches"
    smb_user: "smbuser"
    smb_password: "0pT1mus9r1me#"
    patches:
      - KB5058921.msu
      - KB5055521.msu

  tasks:
    - name: Map network drive with credentials
      win_shell: |
        $username = "{{ smb_user }}"
        $password = "{{ smb_password }}"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)
        
        # Map the drive using New-PSDrive with credentials
        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ patch_share }}" -Credential $credential -Persist

    - name: Install each .msu patch directly from SMB share and wait for completion
      win_shell: |
        $patches = @("KB5058921.msu", "KB5055521.msu")
        foreach ($patch in $patches) {
          $fullPath = "Z:\\$patch"
          $process = Start-Process -FilePath "wusa.exe" -ArgumentList "$fullPath /quiet /norestart" -PassThru
          $process.WaitForExit()
          
          # Check if installation was successful
          if ($process.ExitCode -ne 0) {
            Write-Host "Installation of $patch failed with exit code $($process.ExitCode)"
            exit 1
          }
          else {
            Write-Host "Installation of $patch completed successfully"
          }
        }

    - name: Remove mapped network drive if it exists
      win_shell: |
        if (Get-PSDrive -Name Z -ErrorAction SilentlyContinue) {
            Remove-PSDrive -Name Z
        }
