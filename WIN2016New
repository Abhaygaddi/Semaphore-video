---
- name: Install Windows patches from SMB share
  hosts: windows
  gather_facts: no
  become: yes
  become_method: runas
  become_user: SYSTEM

  vars:
    smb_user: "testdc\\ansible"
    smb_pass: "0pT1mus9r1me#"
    smb_share: "\\\\192.168.29.78\\winpatches"
    patch_list:
      - KB5058921
      - KB5055521

  tasks:

    - name: Mount SMB share using net use
      win_shell: >
        cmd.exe /c "net use Z: {{ smb_share }} /user:{{ smb_user }} {{ smb_pass }} /persistent:no"
      register: mount_result
      failed_when: "'error' in mount_result.stdout.lower() or 'failed' in mount_result.stdout.lower()"
      changed_when: false

    - name: Install patches from Z: drive
      win_shell: >
        $patches = @({{ patch_list | map('regex_replace', '^(.*)$', '"\1"') | join(', ') }})
        foreach ($patch in $patches) {
          $fullPath = "Z:\\$patch.msu"
          $process = Start-Process -FilePath "wusa.exe" -ArgumentList "$fullPath /quiet /norestart" -PassThru
          $process.WaitForExit()
          if ($process.ExitCode -eq 3) {
            Write-Host "Patch $patch is not applicable or already installed"
          } elseif ($process.ExitCode -ne 0) {
            Write-Host "Installation of $patch failed with exit code $($process.ExitCode)"
            cmd.exe /c "net use Z: /delete"
            exit 1
          } else {
            Write-Host "Installation of $patch completed successfully"
          }
        }
        cmd.exe /c "net use Z: /delete"
      register: patch_result
      failed_when: patch_result.rc != 0 and
                   "'exit code 3'" not in patch_result.stdout and
                   "'exit code 3010'" not in patch_result.stdout

    - name: Ensure Z: drive is unmounted (cleanup)
      win_shell: cmd.exe /c "net use Z: /delete"
      ignore_errors: yes
