---
- name: Install patches directly from Linux share and log result
  hosts: WIN2016
  gather_facts: no
  tasks:

    - name: Ensure temp directory exists
      win_file:
        path: C:\temp
        state: directory

    - name: Install patches one by one
      win_shell: |
        $Patch = "{{ item }}"
        $LogFile = "C:\temp\patch_install_log.txt"
        $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $PatchPath = "\\192.168.29.78\winpatches\$Patch.msu"

        # Install the patch silently
        $InstallResult = Start-Process -FilePath "wusa.exe" -ArgumentList "$PatchPath /quiet /norestart" -Wait -PassThru

        Start-Sleep -Seconds 10

        # Check if patch is installed
        $HotfixInstalled = (Get-HotFix | Where-Object { $_.HotFixID -eq $Patch }).HotFixID

        if ($HotfixInstalled) {
            "$Timestamp : $Patch : INSTALLED SUCCESSFULLY" | Out-File -Append -FilePath $LogFile
        } else {
            "$Timestamp : $Patch : INSTALL ATTEMPTED BUT NOT FOUND IN SYSTEM. ExitCode: $($InstallResult.ExitCode)" | Out-File -Append -FilePath $LogFile
        }
      loop:
        - KB5055521
        - KB5058921
      register: patch_results

    - name: Reboot if patch installed successfully
      win_reboot:
        msg: "Rebooting after patch installation"
        pre_reboot_delay: 30
      when: "'INSTALLED SUCCESSFULLY' in patch_results.results | map(attribute='stdout') | join('')"
