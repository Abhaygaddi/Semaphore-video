---
- name: Install Windows patches from Linux SMB share and log result
  hosts: windows
  gather_facts: no
  vars:
    patch_share: "\\\\192.168.29.78\\winpatches"
    patches:
      - KB5055521.msu
      - KB5058921.msu
    log_path: "C:\\Temp\\patch_log.txt"

  tasks:

    - name: Ensure C:\Temp directory exists
      win_file:
        path: "C:\\Temp"
        state: directory

    - name: Install each patch and log results
      win_shell: |
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $patch = "{{ item }}"
        $patchPath = "{{ patch_share }}\\$patch"
        try {
          Start-Process -FilePath "wusa.exe" -ArgumentList "`"$patchPath`" /quiet /norestart" -Wait -ErrorAction Stop
          Add-Content -Path "{{ log_path }}" -Value "$timestamp : $patch : SUCCESS"
        } catch {
          Add-Content -Path "{{ log_path }}" -Value "$timestamp : $patch : FAILED - $($_.Exception.Message)"
        }
      loop: "{{ patches }}"

    - name: Reboot the server after patching
      win_reboot:
        reboot_timeout: 600
        msg: "Rebooting after patch installation"
        pre_reboot_delay: 10
        post_reboot_delay: 30
