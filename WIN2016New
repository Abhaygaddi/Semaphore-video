- name: Install patch from network share via SYSTEM task
  hosts: WIN2016
  gather_facts: no
  vars:
    samba_share_path: "\\\\192.168.29.78\\winpatches"
    patch_filename: "KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"
    task_name: "RunPatchTask"
    task_time: "23:59"  # set it slightly in the future, 24h format

  tasks:
    - name: Ensure patch folder exists
      ansible.windows.win_file:
        path: C:\Temp\patches
        state: directory

    - name: Map share and copy patch locally
      ansible.windows.win_command: >
        cmd.exe /c net use {{ samba_share_path }} {{ samba_password }} /user:{{ samba_user }} &&
        copy {{ samba_share_path }}\\{{ patch_filename }} C:\\Temp\\patches\\ /Y
      register: copy_patch
      changed_when: "'1 file(s) copied' in copy_patch.stdout"

    - name: Create scheduled task to install patch locally as SYSTEM
      ansible.windows.win_command: >
        schtasks /Create /TN {{ task_name }} /TR "wusa C:\\Temp\\patches\\{{ patch_filename }} /quiet /norestart" /SC ONCE /ST {{ task_time }} /RL HIGHEST /RU SYSTEM /F

    - name: Run the scheduled task
      ansible.windows.win_command: >
        schtasks /Run /TN {{ task_name }}

    - name: Wait for the patch to install
      pause:
        seconds: 90
