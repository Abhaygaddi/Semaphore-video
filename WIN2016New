---
- name: Install Windows patch from Samba share using UNC path
  hosts: windows
  gather_facts: no
  vars:
    samba_server: "192.168.29.78"
    samba_share: "winpatches"
    patch_file: "KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"

  tasks:
    - name: Ensure destination folder exists
      ansible.windows.win_file:
        path: "C:\\Temp\\patches"
        state: directory

    - name: Copy patch from Samba share to target using UNC path
      ansible.windows.win_command: >
        cmd.exe /c "copy \\{{ samba_server }}\{{ samba_share }}\{{ patch_file }} C:\Temp\patches\ /Y"
      environment:
        USERNAME: "{{ samba_user }}"
        PASSWORD: "{{ samba_password }}"
      register: copy_result
      failed_when: copy_result.rc != 0
      ignore_errors: no

    - name: Install patch using wusa
      ansible.windows.win_command: >
        wusa.exe "C:\Temp\patches\{{ patch_file }}" /quiet /norestart
      register: install_result
      failed_when: install_result.rc != 0
      ignore_errors: no

    - name: Reboot if required
      ansible.windows.win_reboot:
        reboot_timeout: 600
      when: install_result.reboot_required is defined and install_result.reboot_required
