---
- name: Install patches from network share via mapped drive
  hosts: WIN2016
  gather_facts: no
  tasks:

    - name: Ensure C:\temp exists for logging
      win_file:
        path: C:\temp
        state: directory

    - name: Map network drive Z:
      win_mapped_drive:
        letter: Z
        path: '\\192.168.29.78\winpatches'
        state: present
        user: 'TESTDC\\ansible'
        password: '0pT1mus9r1me#'
        persistent: no

    - name: Verify if drive Z: is mapped
      win_shell: |
        if (!(Test-Path Z:\)) {
          Write-Host "Drive Z: not mapped"
          exit 1
        } else {
          Write-Host "Drive Z: mapped successfully"
        }
      register: drive_check
      failed_when: drive_check.rc != 0

    - name: Install patches from Z: and log results
      win_shell: |
        $Patch = "{{ item }}"
        $PatchPath = "Z:\$Patch.msu"
        $LogFile = "C:\temp\patch_install_log.txt"
        $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        $Install = Start-Process -FilePath "wusa.exe" -ArgumentList "$PatchPath /quiet /norestart" -Wait -PassThru
        Start-Sleep -Seconds 10

        $Hotfix = Get-HotFix | Where-Object { $_.HotFixID -eq $Patch }

        if ($Hotfix) {
            "$Timestamp : $Patch : INSTALLED SUCCESSFULLY" | Out-File -FilePath $LogFile -Append
        } else {
            "$Timestamp : $Patch : INSTALL ATTEMPTED BUT NOT FOUND IN SYSTEM : ExitCode $($Install.ExitCode)" | Out-File -FilePath $LogFile -Append
        }
      loop:
        - KB5055521
        - KB5058921
      register: patch_results

    - name: Unmap network drive Z:
      win_mapped_drive:
        letter: Z
        state: absent

    - name: Reboot if patches were installed
      win_reboot:
        msg: "Rebooting after patch installation"
        pre_reboot_delay: 30
      when: "'INSTALLED SUCCESSFULLY' in patch_results.results | map(attribute='stdout') | join('')"
