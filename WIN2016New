- name: Copy patch from Samba to Windows target and install
  hosts: windows
  gather_facts: no
  vars:
    samba_server: "192.168.29.78"
    samba_share: "winpatches"
    patch_file: "KB5058921.msu"
    dest_path: "C:\\Temp\\patches\\KB5058921.msu"
    samba_user: "smbuser"
    samba_password: "0pT1mus9r1me#"
  tasks:
    - name: Ensure destination directory exists
      ansible.windows.win_file:
        path: "C:\\Temp\\patches"
        state: directory

    - name: Map network drive with Samba credentials
      ansible.windows.win_command: >
        cmd.exe /c net use \\{{ samba_server }}\{{ samba_share }}
        {{ samba_password }} /user:{{ samba_user }}
      register: net_use_result
      failed_when: "'The command completed successfully' not in net_use_result.stdout"

    - name: Copy patch file from Samba share
      ansible.windows.win_command: >
        cmd.exe /c copy \\{{ samba_server }}\{{ samba_share }}\{{ patch_file }}
        {{ dest_path }} /Y
      register: copy_result
      failed_when: "'1 file(s) copied' not in copy_result.stdout"

    - name: Unmap network share
      ansible.windows.win_command: >
        cmd.exe /c net use \\{{ samba_server }}\{{ samba_share }} /delete
      ignore_errors: yes
