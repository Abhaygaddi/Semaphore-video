---
- name: Install updates on Windows 2016
  hosts: WIN2016
  tasks:
    - name: Install patches from SMB share
      win_shell: |
        $username = "smbuser"
        $password = "0pT1mus9r1me#"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

        New-PSDrive -Name Z -PSProvider FileSystem -Root "\\192.168.29.78\winpatches" -Credential $credential | Out-Null
        
        $patches = @("KB5058921", "KB5055521")
        foreach ($patch in $patches) {
          $fullPath = "Z:\\$patch.msu"
          $process = Start-Process -FilePath "wusa.exe" -ArgumentList "$fullPath /quiet /norestart" -PassThru
          $process.WaitForExit()

          # Check if installation was successful
          if ($process.ExitCode -ne 0) {
            Write-Host "Installation of $patch failed with exit code $($process.ExitCode)"
            exit 1
          }
          else {
            Write-Host "Installation of $patch completed successfully"
          }
        }

        Remove-PSDrive -Name Z
