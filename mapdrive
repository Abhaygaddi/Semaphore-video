---
- name: Install patches from network share and force reboot
  hosts: windows
  gather_facts: yes
  become: yes
  become_method: runas
  become_user: Administrator # Or an account with local admin rights

  vars:
    patch_share: '\\192.168.29.132\\Patches'
    kb5058921_path: '{{ patch_share }}\KB5058921.msu'
    kb5055521_path: '{{ patch_share }}\KB5055521.msu'

  tasks:
    - name: Test access to the network share using Get-ChildItem
      win_shell: |
        Try {
          Get-ChildItem -Path "{{ patch_share }}" -ErrorAction Stop
          Write-Output "Successfully accessed the share."
          exit 0
        }
        Catch {
          Write-Error "Failed to access the share: $($_.Exception.Message)"
          exit 1
        }
      register: share_access_test
      failed_when: share_access_test.rc != 0

    - name: Debug - Print output of share access test
      debug:
        var: share_access_test

    - name: Install Patch KB5058921.msu using win_shell (direct wusa)
      win_shell: |
        $patchPath = "{{ kb5058921_path }}"
        Start-Process -FilePath "C:\\Windows\\System32\\wusa.exe" -ArgumentList "$patchPath /quiet /norestart" -Wait -Verb RunAs
      register: install_kb5058921

    - name: Debug - Print result of KB5058921 installation
      debug:
        var: install_kb5058921

    - name: Install Patch KB5055521.msu using win_shell (direct wusa)
      win_shell: |
        $patchPath = "{{ kb5055521_path }}"
        Start-Process -FilePath "C:\\Windows\\System32\\wusa.exe" -ArgumentList "$patchPath /quiet /norestart" -Wait -Verb RunAs
      register: install_kb5055521

    - name: Debug - Print result of KB5055521 installation
      debug:
        var: install_kb5055521

    - name: Force Reboot the server after patch installations
      win_reboot:
        reboot_timeout: 600
        force: yes
