---
- name: Install Windows patch from network share
  hosts: windows
  gather_facts: no
  vars:
    share_path: "\\\\192.168.29.132\\Patches"   # Double backslashes for UNC path
    patch_file: "KB50558921.msu"
    mapped_drive: "Z"
    domain_user: "DOMAIN\\ansible"             # Replace DOMAIN or use .\ansible for local user
    domain_pass: "0pT1mus9r1me#"

  tasks:
    - name: Unmap drive Z if it exists
      win_command: "net use {{ mapped_drive }}: /delete"
      ignore_errors: true

    - name: Map network drive
      win_command: >
        net use {{ mapped_drive }}: {{ share_path }} /user:{{ domain_user }} {{ domain_pass }}
      register: map_result
      ignore_errors: true

    - name: Fail if mapping failed
      fail:
        msg: "Failed to map network drive. Details: {{ map_result }}"
      when: map_result.rc != 0

    - name: Install patch using wusa.exe from mapped drive
      win_command: >
        wusa.exe "{{ mapped_drive }}:\\{{ patch_file }}" /quiet /norestart
      become: yes
      become_method: runas
      become_user: SYSTEM
      register: patch_result
      failed_when: patch_result.rc != 0

    - name: Unmap network drive
      win_command: "net use {{ mapped_drive }}: /delete"
      when: map_result.rc == 0
