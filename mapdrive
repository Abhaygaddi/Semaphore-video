---
- name: Install patches from network share and reboot if needed
  hosts: windows
  gather_facts: yes

  tasks:
    - name: Map network drive Z
      win_mapped_drive:
        letter: Z
        path: '\\192.168.29.132\Patches'
        state: present

    - name: Verify that the patch file exists
      win_stat:
        path: 'Z:\\KB5058921.msu'
      register: patch_status

    - name: Debug patch file existence
      debug:
        var: patch_status

    - name: Install Patch KB5058921.msu if present
      win_shell: |
        if (Test-Path "Z:\\KB5058921.msu") {
          $patchPath = "Z:\\KB5058921.msu"
          Write-Output "Starting installation of $patchPath"
          $process = Start-Process wusa -ArgumentList "$patchPath /quiet /norestart" -PassThru -Wait -Verb runAs
          Add-Content -Path "C:\\patch_install.log" -Value "Patch KB5058921.msu - Exit Code: $($process.ExitCode)"
          if ($process.ExitCode -eq 0) {
            Write-Output "Patch KB5058921.msu installed successfully."
          } else {
            Write-Output "Failed to install patch KB5058921.msu. Exit code: $($process.ExitCode)"
          }
        } else {
          Write-Output "Patch KB5058921.msu is missing."
        }
      register: patch_install_result

    - name: Debug patch installation result
      debug:
        var: patch_install_result

    - name: Install Patch KB5055521.msu if present
      win_shell: |
        if (Test-Path "Z:\\KB5055521.msu") {
          $patchPath = "Z:\\KB5055521.msu"
          Write-Output "Starting installation of $patchPath"
          $process = Start-Process wusa -ArgumentList "$patchPath /quiet /norestart" -PassThru -Wait -Verb runAs
          Add-Content -Path "C:\\patch_install.log" -Value "Patch KB5055521.msu - Exit Code: $($process.ExitCode)"
          if ($process.ExitCode -eq 0) {
            Write-Output "Patch KB5055521.msu installed successfully."
          } else {
            Write-Output "Failed to install patch KB5055521.msu. Exit code: $($process.ExitCode)"
          }
        } else {
          Write-Output "Patch KB5055521.msu is missing."
        }
      register: patch_install_result_2

    - name: Debug second patch installation result
      debug:
        var: patch_install_result_2

    - name: Reboot the server after patch installation (if necessary)
      win_reboot:
        reboot_timeout: 600
        test_command: whoami
      when: patch_install_result.rc == 0 or patch_install_result_2.rc == 0
