---
- name: Run patch script from shared drive on Windows hosts
  hosts: windows
  gather_facts: no
  vars:
    drive_letter: "Z"
    share_path: "\\\\192.168.29.132\\Patches"
    domain_user: "testdc\\ansible"
    password: "0pT1mus9r1me#"
    patch_script: "Z:\\Patch.ps1"

  tasks:

    - name: Map network drive
      win_shell: |
        net use {{ drive_letter }}: {{ share_path }} /user:{{ domain_user }} "{{ password }}"
      args:
        executable: cmd

    - name: Verify patch script exists
      win_shell: |
        if (Test-Path "{{ patch_script }}") {
          Write-Host "Found"
        } else {
          Write-Host "Missing"
          exit 1
        }
      register: script_check
      failed_when: "'Found' not in script_check.stdout"

    - name: Run patch script
      win_shell: powershell.exe -ExecutionPolicy Bypass -File "{{ patch_script }}"
      register: patch_result
      failed_when: patch_result.rc != 0
      ignore_errors: no

    - name: Unmap network drive
      win_shell: |
        net use {{ drive_letter }}: /delete /yes
      args:
        executable: cmd
      ignore_errors: yes
