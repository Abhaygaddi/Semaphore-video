---
- name: Run patch script from shared drive on Windows hosts
  hosts: windows
  gather_facts: no
  vars:
    drive_letter: "Z"
    share_path: "\\\\192.168.29.132\\Patches"
    username: "testdc\\ansible"
    password: "0pT1mus9r1me#"
    patch_script: "Z:\\Patch.ps1"

  tasks:

    - name: Map network drive using net use
      win_shell: |
        net use {{ drive_letter }}: {{ share_path }} /user:{{ username }} "{{ password }}"
      register: map_result
      failed_when: "'The command completed successfully' not in map_result.stdout"

    - name: Run patch script from mapped drive
      win_shell: |
        powershell.exe -ExecutionPolicy Bypass -File "{{ patch_script }}"
      register: patch_result
      failed_when: patch_result.rc != 0

    - name: Display patch script output
      debug:
        var: patch_result.stdout_lines

    - name: Unmap network drive
      win_shell: |
        net use {{ drive_letter }}: /delete /y
      register: unmap_result
      failed_when: "'was deleted successfully' not in unmap_result.stdout and 'The network connection could not be found' not in unmap_result.stdout"
