---
- name: Install Windows Patches from Network Share with Logging and Reboot
  hosts: all
  gather_facts: no
  tasks:
    - name: Install patch KB5055521.msu from network share
      win_shell: |
        wusa.exe /quiet /norestart \\192.168.29.132\Patches\KB5055521.msu
      register: install_result_1
    - name: Install patch KB5058921.msu from network share
      win_shell: |
        wusa.exe /quiet /norestart \\192.168.29.132\Patches\KB5058921.msu
      register: install_result_2
    - name: Create log file
      win_shell: |
        $logPath = "C:\temp\patch_installation.log"
        "KB5055521 Installation Result: $($install_result_1.stdout) $($install_result_1.stderr) Return Code: $($install_result_1.rc)" | Out-File -FilePath $logPath -Append
        "KB5058921 Installation Result: $($install_result_2.stdout) $($install_result_2.stderr) Return Code: $($install_result_2.rc)" | Out-File -FilePath $logPath -Append

        $rebootRequired1 = $false
        $rebootRequired2 = $false

        if ($install_result_1.stdout -like "*Restart needed*") {
            $rebootRequired1 = $true
            "KB5055521: Restart is needed" | Out-File -FilePath $logPath -Append
        }
        if ($install_result_2.stdout -like "*Restart needed*") {
            $rebootRequired2 = $true
            "KB5058921: Restart is needed" | Out-File -FilePath $logPath -Append
        }

        if ($rebootRequired1 -eq $true -or $rebootRequired2 -eq $true) {
          "Reboot is required." | Out-File -FilePath $logPath -Append
        }
        else {
          "Reboot is not required." | Out-File -FilePath $logPath -Append
        }
      register: log_result #register the output
    - name: Print log results
      debug:
        var: log_result
    - name: Reboot the server if required
      win_reboot:
      when: log_result.changed
