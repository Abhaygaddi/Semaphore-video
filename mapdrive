---
- name: Map drive and install patches
  hosts: windows
  gather_facts: no
  tasks:
    - name: Map network drive Z
      win_mapped_drive:
        letter: Z
        path: "\\\\192.168.29.78\\winpatches"
        state: present
        username: "testdc\\ansible"
        password: "0pT1mus9r1me#"
    
    - name: Check if the network drive Z is mapped
      win_command: net use Z:
      register: net_use_status
      failed_when: false

    - name: Fail if the network drive Z is not mapped
      fail:
        msg: "Network drive Z: could not be mapped. Check the share configuration."
      when: "'Z:' not in net_use_status.stdout"

    - name: Install patch KB5055521
      win_command: "msiexec /i Z:\\KB5055521.msu /quiet /norestart"
      register: install_kb5055521
      ignore_errors: yes

    - name: Install patch KB5058921
      win_command: "msiexec /i Z:\\KB5058921.msu /quiet /norestart"
      register: install_kb5058921
      ignore_errors: yes

    - name: Log installation results for KB5055521
      copy:
        content: "{{ ansible_date_time.iso8601 }} : KB5055521 : {{ install_kb5055521.stdout }}"
        dest: "C:\\temp\\patch_install_log.txt"
        append: yes

    - name: Log installation results for KB5058921
      copy:
        content: "{{ ansible_date_time.iso8601 }} : KB5058921 : {{ install_kb5058921.stdout }}"
        dest: "C:\\temp\\patch_install_log.txt"
        append: yes

    - name: Reboot the server after patch installation
      win_reboot:
        reboot_timeout: 600
        test_command: "echo Reboot complete"
        pre_reboot_delay: 5
        post_reboot_delay: 5
      when: install_kb5055521.rc == 0 or install_kb5058921.rc == 0

    - name: Unmap the network drive Z after installation
      win_mapped_drive:
        letter: Z
        state: absent
