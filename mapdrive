---
- name: Install patches from network share and reboot if needed (UNC path access test)
  hosts: windows
  gather_facts: yes
  become: yes
  become_method: runas
  become_user: testdc\ansible # Or an account with local admin rights

  vars:
    patch_share: '\\192.168.29.132\Patches'
    kb5058921_path: '{{ patch_share }}\KB5058921.msu'

  tasks:
    - name: Test access to the network share using Get-ChildItem
      win_shell: |
        Try {
          Get-ChildItem -Path "{{ patch_share }}" -ErrorAction Stop
          Write-Output "Successfully accessed the share."
          exit 0
        }
        Catch {
          Write-Error "Failed to access the share: $($_.Exception.Message)"
          exit 1
        }
      register: share_access_test
      failed_when: share_access_test.rc != 0

    - name: Debug - Print output of share access test
      debug:
        var: share_access_test

    - name: Check if KB5058921.msu exists (after access test)
      win_stat:
        path: '{{ kb5058921_path }}'
      register: kb5058921_stat

    - name: Fail if KB5058921.msu does not exist
      fail:
        msg: "Patch file '{{ kb5058921_path }}' does not exist or is not accessible on the network share."
      when: not kb5058921_stat.stat.exists

    - name: Install Patch KB5058921.msu using UNC path
      win_package:
        path: '{{ kb5058921_path }}'
        state: present
        arguments: '/quiet /norestart'
      register: kb5058921_result

    - name: Log KB5058921 installation status
      win_shell: |
        Add-Content -Path "C:\patch_install.log" -Value "Patch KB5058921.msu - Exit Code: $($_.ExitCode)"
      when: kb5058921_result is defined

    # ... (rest of the playbook for the second patch and reboot) ...
