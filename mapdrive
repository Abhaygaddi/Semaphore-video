---
- name: Install Windows Patches from Network Share with Logging
  hosts: all
  gather_facts: no
  tasks:
    - name: Install patch KB5055521.msu from network share
      win_shell: |
        wusa.exe /quiet /norestart \\192.168.29.132\Patches\KB5055521.msu
      register: install_result_1
    - name: Install patch KB5058921.msu from network share
      win_shell: |
        wusa.exe /quiet /norestart \\192.168.29.132\Patches\KB5058921.msu
      register: install_result_2
    - name: Create log file
      win_shell: |
        $logPath = "C:\temp\patch_installation.log"
        "KB5055521 Installation Result: $($install_result_1.stdout) $($install_result_1.stderr)" | Out-File -FilePath $logPath -Append
        "KB5058921 Installation Result: $($install_result_2.stdout) $($install_result_2.stderr)" | Out-File -FilePath $logPath -Append
        if ($install_result_1.rc -eq 0 -or $install_result_2.rc -eq 0) {
          "Patches Installed Successfully" | Out-File -FilePath $logPath -Append
        }
        if ($install_result_1.reboot_required -eq $true -or $install_result_2.reboot_required -eq $true) {
          "Reboot is required." | Out-File -FilePath $logPath -Append
        } else {
          "Reboot is not required." | Out-File -FilePath $logPath -Append
        }
    - name: Reboot the server if required
      win_reboot:
      when: install_result_1.reboot_required or install_result_2.reboot_required
